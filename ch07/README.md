#第 7 章  套接字选项


###1. getsockopt和setsockopt函数
```C
#include <sys/socket.h>

int getsockopt(int sockfd, int level, int optname, void *optval, socklen_t *optlen);

int setsockopt(int sockfd, int level, int optname, const void *optval, socklen_t optlen);
		//作用：这两个函数仅用于套接字，用来获取和设置套接字选项
		//返回：若成功则为0，若出错则为-1
```	


###2. 通用套接字选项
>
1. **SO_BROADCAST**套接字选项   
本选项开启或静止进程发送广播消息的能力。只有**UDP**支持广播，并且还必须是在支持广播的**网络上**(例如以太网、令牌环网等。),不可能在**点对点链路**上进行广播。   
2. **SO_DEBUG**套接字选项    
本选项仅由**TCP**支持。本选项开启时，内核将为该套接字在TCP上发送和接收的所有分组保留**详细跟踪消息**。这些消息保存在内核的某个环形缓冲区中，并可使用**trpt程序**进行检查。    
3. **SO_DONTROUTE**套接字选项   
本选项设定可以规定外出的分组将**绕过底层协议的正常路由机制**。即可以自己选择某个接口发出数据，而不是根据目的地址进行路由选择到一个合适的本地接口出去(绕过路由表).   
4. **SO_ERROR**套接字选项   
对套接字发生错误的记录。若发生错误时阻塞在**select**的调用上时，可读和可写均满足条件。若进程采用了**信号驱动式I/O模型**，那么给进程或进程组产生一个SIGIO信号。
这**两种情况**返回后，可以使用getsockopt访问SO_ERROR得到待处理错误。随后so_error被**内核复位为0**。  
如果调用read且**没有数据返回**时，read返回-1，且errno值被设定为so_error，随后so_error被**内核复位为0**。如果**有数据返回**时，则read返回数据而不是返回错误条件。   
如果调用write时so_error非0，write返回-1，且errno值被设定为so_error，随后so_error被**内核复位为0**。**一个套接字上错误一旦返回给用户，它的so_error就得复位为0.   
5. **SO_KEEPSLIVE**套接字选项   
设定一个**TCP套接字**的保持存活选项,如果**2个小时**内在该套接字的任一方向上都没有数据交换，TCP就自动给对端发送一个**保持存活探测分节**。这个2小时可以在内核中修改，不过一般不改动。本选项的功能是**检测对端主机是否崩溃或变得不可达**。有些服务器一般采取提供一个分钟量级的**应用层超时**机制来进行清除不可达用户。    
6. **SO_LINGER**套接字选项   
本选项指定**close函数**对面向连接的协议如何操作。    
7. **SO_OOBINLINE**套接字选项  
本选项开启后，**带外数据**将被留在**正常的输入队列**中（即在线留存）。此时接受函数的MSG_OOB标志不能用来读带外数据。   
8. **SO_RCVBUF**和**SO_SNDBUF**套接字选项  
这两个选项是设定接收和发送缓冲区的大小的。对于TCP套接字的**接收缓冲区**，因为TCP的窗口规模在建立连接时用**SYN分节**和对端互换得到的，故对于**客户**而言，必须在调用**connect之前**设置；
对于**服务器**而言，必须在**listen之前**设置。（套接字缓冲区的大小总有由先创建的**已连接套接字**从**监听套接字**继承而来的）    
TCP套接字缓冲区的大小至少应该是相应连接的MSS值的**四倍**，其中之一的依据是TCP快速恢复算法机制。为避免浪费缓冲区空间，往往其大小必须是MSS值的**偶数**倍。
有些实现中实行**向上舍入**，即假如默认为8192，但是当前为以太网其MSS为1460，那么缓冲区大小变为8760 (6*1460),变得比以前大了且为MSS的偶数倍。TCP的最大正常窗口大小为65535（16位）。
9. **SO_RCVLOWAT**和**SO_SNDLOWAT**套接字选项  
修改**接受低水位标记**(接收缓冲区中的数据量)和**发送低水位标记**(发送缓冲区中可用空间).     
10. **SO_RCVTIMEO**和**SO_SNDTIMEO**套接字选项  
设定套接字的接收和发送的超时值。默认是0，代表着不设置超时。      
接收超时影响5个**输入**函数：read、readv、recv、recvfrom和recvmsg。   
发送超时影响5个**输出**函数：write、writev、send、sendto和sendmsg。    
11. **SO_REUSEADDR**和**SO_REUSEPORT**套接字选项   
**SO_REUSEADDR**允许多个IP地址绑定一个端口，允许多个套接字绑定相同的IP地址和相同的端口（仅UDP，一般用于多播）。**SO_REUSEPORT**允许**完全重复的绑定**，不过所有绑定的套接字都得开启这个选项，同时这个选项**并不是**所有的系统都提供了实现。   
12. **SO_TYPE**套接字选项   
本选项返回套接字的类型，如SOCK_STREAM等整数值。本选项通常由启动时继承了套接字的进程使用。    
13. **SO_USELOOPBACK**套接字选项   
本选项仅用于**路由域(AF_ROUTE)的套接字。默认是打开（这是唯一一个默认打开的SO_xxx二元套接字选项）。当本选项开启时，相应套接字将接收在其上发送的任何数据报的一个副本。   


###3. IPv4套接字选项   
>
1. **IP_HDRINCL**套接字选项    
开启本选项可以自己构造完整的IP首部，一般用于原始IP套接字。   
2. **IP_OPTIONS**套接字选项  
本选项的设置允许我们在IPv4首部中设置IP选项。   
3. **IP_RECVDSTADDR**套接字选项   
本套接字选项导致所收到的**UDP数据报的目的IP地址**由recvmsg函数作为辅助数据返回。   
4. **IP_RECVIF**套接字选项  
本套接字选项导致所收到的**UDP数据报的接收接口索引**由recvmsg函数作为辅助数据返回。    
5. **IP_TOS**套接字选项   
设置IP首部中的服务类型和优先权。    
6. **IP_TTL**套接字选项   
设置和获取给某个给定套接字发送的单播分组上的默认TTL。TCP和UDP默认是64，原始套接字默认是255。和TOS字段一样，调用getsockopt只能获得**外出数据报的字段的默认值**，**接收到**的IP数据报**无法获取**。     


###4. TCP套接字选项  
>
1. **TCP_MAXSEG**套接字选项   
通过本选项可以获取和设置TCP连接的最大分节大小（MSS）。一般都是建立连接时，对方使用SYN通告的。通过其选项设置MSS有的实现中不一定支持，且若可以设置，一般只能减小，不能增加，因为这已经是每个分节的最大数据量了。   
2. **TCP_NODELAY**套接字选项   
开启本选项将**禁止TCP的Nagle算法**，默认该算法是开启的。   


###5. fcntl函数  
```C
#include <fcntl.h>

int fcntl(int fd, int cmd, ... /* int arg */);
		//作用：获取或改变描述符的属性
		//返回：若成功则取决于cmd，若出错则为-1
```

> 对于非阻塞式I/O设置的常用代码    

```C
int flags;

//获取之前的文件状态标志，不可以直接设置，否则会清除之前的其他文件状态标志   
if((flags = fcntl(fd, F_GETFL, 0)) < 0)
	err_sys("F_GETFL error");

flags |= O_NONBLOCK;  
if(fcntl(fd, F_SETFL, flags) < 0)
	err_sys("F_GETFL error");

```

> 关闭非阻塞式标志的常用代码   

```C
flags &= ~O_NONBLOCK;
if(fcntl(fd, F_SETFL, flags) < 0)
	err_sys("F_SETFL error");
```

> 同理，可以设置**O_ASYNC状态标志**实现**信号驱动式I/O**。 F_SETOWN命令可以指定用于接收SIGIO和SIGURG信号的套接字属主(进程ID或进程组ID)。F_GETOWN命令可以获取套接字的当前属主。   


###6. MSS的确认过程
![MSS](cl.ly/0t0F3Y1v0P0H)















